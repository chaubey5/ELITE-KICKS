<!-- Load Chatbot CSS -->
<link rel="stylesheet" href="{% load static %}{% static 'css/chatbot.css' %}">

<!-- Chatbot Container -->
<div class="chatbot-container">
    <!-- Chatbot Toggle Button -->
    <button class="chatbot-toggle" id="chatbotToggle" title="Chat with our AI Assistant">
        <i class="fas fa-robot"></i>
    </button>
    
    <!-- Chatbot Window -->
    <div class="chatbot-window" id="chatbotWindow">
        <!-- Chatbot Header -->
        <div class="chatbot-header">
            <h5>
                <i class="fas fa-robot me-2"></i>
                Shoe Store Assistant
            </h5>
            <button class="chatbot-close" id="chatbotClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Chatbot Messages -->
        <div class="chatbot-messages" id="chatbotMessages">
            <!-- Welcome message will be added here -->
        </div>
        
        <!-- Chatbot Input -->
        <div class="chatbot-input">
            <form class="chatbot-input-form" id="chatbotForm">
                <input type="text" class="chatbot-input-field" id="chatbotInput" placeholder="Type your message..." autocomplete="off">
                <button type="submit" class="chatbot-send-btn" id="chatbotSend">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>
</div>

 <!-- Chatbot JavaScript -->
 <script>
 console.log('Chatbot script loaded!');
 document.addEventListener('DOMContentLoaded', function() {
     const chatbotToggle = document.getElementById('chatbotToggle');
     const chatbotWindow = document.getElementById('chatbotWindow');
     const chatbotClose = document.getElementById('chatbotClose');
     const chatbotMessages = document.getElementById('chatbotMessages');
     const chatbotForm = document.getElementById('chatbotForm');
     const chatbotInput = document.getElementById('chatbotInput');
     const chatbotSend = document.getElementById('chatbotSend');
     
     let isOpen = false;
     
     // Ensure all elements exist
     if (!chatbotToggle || !chatbotWindow || !chatbotClose || !chatbotMessages || !chatbotForm || !chatbotInput) {
         console.error('Chatbot elements not found');
         return;
     }
     
     // Add a small indicator to show chatbot is ready
     chatbotToggle.setAttribute('title', 'Chat with us!');
     chatbotToggle.classList.add('ready');
     
     // Add a console log to confirm chatbot is loaded
     console.log('Chatbot initialized successfully!');
    
    // Toggle chatbot window
    function toggleChatbot() {
        isOpen = !isOpen;
        chatbotWindow.classList.toggle('active', isOpen);
        chatbotToggle.classList.toggle('active', isOpen);
        
        if (isOpen && chatbotMessages.children.length === 0) {
            // Add welcome message
            addBotMessage({
                text: "Hello! ðŸ‘‹ I'm your AI-powered Shoe Store Assistant. I can help you with anything - from finding the perfect shoes to answering questions about orders, returns, sizing, and more. What can I help you with today?",
                suggestions: ['Show me trending shoes', 'Help me find my size', 'Track my order', 'What are your return policies?']
            });
        }
    }
    
    // Add user message
    function addUserMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chatbot-message user';
        messageDiv.innerHTML = `
            <div class="chatbot-message-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="chatbot-message-content">${text}</div>
        `;
        chatbotMessages.appendChild(messageDiv);
        scrollToBottom();
    }
    
    // Add bot message
    function addBotMessage(response) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chatbot-message bot';
        
        let suggestionsHtml = '';
        if (response.suggestions && response.suggestions.length > 0) {
            suggestionsHtml = `
                <div class="chatbot-suggestions">
                    ${response.suggestions.map(suggestion => 
                        `<span class="chatbot-suggestion" onclick="sendSuggestion('${suggestion}')">${suggestion}</span>`
                    ).join('')}
                </div>
            `;
        }
        
        messageDiv.innerHTML = `
            <div class="chatbot-message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="chatbot-message-content">
                ${response.text}
                ${suggestionsHtml}
            </div>
        `;
        chatbotMessages.appendChild(messageDiv);
        scrollToBottom();
    }
    
    // Show typing indicator
    function showTyping() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'chatbot-message bot';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="chatbot-message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="chatbot-message-content">
                <div class="chatbot-typing">
                    <span>Assistant is typing</span>
                    <div class="chatbot-typing-dots">
                        <div class="chatbot-typing-dot"></div>
                        <div class="chatbot-typing-dot"></div>
                        <div class="chatbot-typing-dot"></div>
                    </div>
                </div>
            </div>
        `;
        chatbotMessages.appendChild(typingDiv);
        scrollToBottom();
    }
    
    // Hide typing indicator
    function hideTyping() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }
    
    // Scroll to bottom of messages
    function scrollToBottom() {
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }
    
    // Send message to chatbot
    async function sendMessage(message) {
        if (!message.trim()) return;
        
        // Add user message
        addUserMessage(message);
        
        // Clear input
        chatbotInput.value = '';
        
        // Show typing indicator
        showTyping();
        
        try {
                         // Send to backend
             const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
             const response = await fetch('/chatbot/', {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json',
                     'X-Requested-With': 'XMLHttpRequest',
                     'X-CSRFToken': csrfToken
                 },
                 body: JSON.stringify({ message: message })
             });
            
            const data = await response.json();
            
            // Hide typing indicator
            hideTyping();
            
            if (data.success) {
                // Add bot response
                addBotMessage(data.response);
            } else {
                addBotMessage({
                    text: "Sorry, I'm having trouble responding right now. Please try again later.",
                    suggestions: ['Try again', 'Contact support']
                });
            }
        } catch (error) {
            hideTyping();
            addBotMessage({
                text: "Sorry, I'm having trouble connecting. Please check your internet connection.",
                suggestions: ['Try again', 'Contact support']
            });
        }
    }
    
    // Handle suggestion clicks
    window.sendSuggestion = function(suggestion) {
        sendMessage(suggestion);
    };
    
    // Event listeners
    chatbotToggle.addEventListener('click', toggleChatbot);
    chatbotClose.addEventListener('click', toggleChatbot);
    
    chatbotForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = chatbotInput.value.trim();
        if (message) {
            sendMessage(message);
        }
    });
    
    // Handle Enter key
    chatbotInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            const message = chatbotInput.value.trim();
            if (message) {
                sendMessage(message);
            }
        }
    });
    
    // Close chatbot when clicking outside
    document.addEventListener('click', function(e) {
        if (isOpen && !chatbotWindow.contains(e.target) && !chatbotToggle.contains(e.target)) {
            toggleChatbot();
        }
    });
    
         // Auto-open chatbot after 10 seconds on first visit
     setTimeout(function() {
         if (!localStorage.getItem('chatbotOpened') && !isOpen) {
             localStorage.setItem('chatbotOpened', 'true');
             toggleChatbot();
         }
     }, 10000);
     
     // Make toggleChatbot function globally accessible
     window.toggleChatbot = toggleChatbot;
     
     // Override the global openChatbot function with our local one
     window.openChatbot = function() {
         if (!isOpen) {
             toggleChatbot();
         }
     };
 });
</script>
